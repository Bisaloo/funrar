---
title: "Benchmark of Distinctiveness"
author: "Matthias Greni\u00e9"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# `outlieR` functions benchmark

`outlieR` lets you use either "tidy" formatted community table for your indices or site-species matrix. The aim of this vignette is to test how are `outlieR`'s functions senstitive datasets size.

In this vignette we will use `outlieR` for its functions and `microbenchmark` packages to compare functions speed.

```{r loadingPackages}
library(microbenchmark)
library(outlieR)
```



## Generating datasets

To compare speed of functions we have to generate different types of datasets: tidy table or site-species matrix, square (number of sites = number of species) or rectangular (higher number of sites vs. species or vice-versa), small vs. large, presence-absence vs. relative abundances, high number of zeros vs. not high.

```{r functGenerateData}
# Function to generate dataset
gen_data = function(n_sites = 50, n_species = 50, prob) {
  # Generate presence-absence matrix
  mat = matrix(rbinom(n_species*n_sites, 1, prob), n_species, n_sites)
  
  # Discard empty rows and empty columns
  col_sum = colSums(mat)
  row_sum = rowSums(mat)
  mat = mat[which(row_sum != 0), which(col_sum != 0)]
  
  # Assign names
  colnames(mat) = paste0("com", 1:ncol(mat))
  rownames(mat) = paste0("sp", 1:nrow(mat))
  
  # Make corresponding table
  tab = reshape2::melt(mat)
  colnames(tab) = c("species", "com", "pres")
  tab = tab[which(tab$pres == 1),]
  
  # Generate distance matrix
  dist_vec = runif((n_species*(n_species - 1))/2)
  
  dist_matrix = diag(0, ncol = n_species, nrow = n_species)
  
  dist_matrix[upper.tri(dist_matrix, diag = F)] = dist_vec
  
  dist_matrix = dist_matrix + t(dist_matrix)
  
  colnames(dist_matrix) = rownames(mat)
  rownames(dist_matrix) = rownames(mat)
  
  return(list(mat, tab, dist_matrix))
}
```

Now that we have our function to generate our dataset we can generate test on the whole variety of datasets and make benchmark. To easily compare between datasets we can design a function that benchmarks the two datasets:

```{r benchmarkF}
# 'dataset' variable results of function 'gen_data()'
benchmark = function(dataset, times = 20) {

  dataset[[2]]$species = as.character(dataset[[2]]$species)

  bench = microbenchmark(
    table = distinctiveness(dataset[[2]], sp_col = "species",
                            com = "com", abund = NULL,
                            dist_matrix = dataset[[3]]),
    matrix = pres_distinctiveness(dataset[[1]],
                                  dataset[[3]]), times = times
  )
  
  return(bench)
}
```



## Small datasets

### Square Matrix

```{r smallDataSquare}
smallest_square = benchmark(gen_data(10, 10, 0.5), 100)

small_square = benchmark(gen_data(50, 50, 0.5), 100)
```


### Rectangular

```{r smallDataRect}
small_rect_sp = benchmark(gen_data(10, 100, 0.5))

small_rect_sites = benchmark(gen_data(100, 10, 0.5))
```



## Large datasets

### Square

```{r largeDataSquare}
large_square = benchmark(gen_data(1000, 1000, 0.5))
larger_square = benchmark(gen_data(3000, 3000, 0.5), 5)
```


### Rectangular

```{r largeDataRect}
large_rect_sites = benchmark(gen_data(3000, 400, 0.5))
large_rect_sp = benchmark(gen_data(400, 3000, 0.5))

larger_rect_sites = benchmark(gen_data(10000, 1000, 0.5), 5)
larger_rect_sp = benchmark(gen_data(1000, 10000, 0.5), 5)
```



## Graph Comparing Speed

```{r speedPlot}
library(ggplot2)

make_microb_df = function(microbench, shape, size, type) {
  df = as.data.frame(microbench)
  df[["shape"]] = shape
  df[["size"]] = size
  df[["type"]] = type
  
  return(df)
}

smallest_square_df = make_microb_df(smallest_square, "square", "smallest", NA)

small_square_df = make_microb_df(small_square, "square", "small", NA)

small_rect_sites_df = make_microb_df(small_rect_sites, "rect", "small", "sites")

small_rect_sp_df = make_microb_df(small_rect_sp, "rect", "small", "species")

large_square_df = make_microb_df(large_square, "square", "large", NA)

larger_square_df = make_microb_df(larger_square, "square", "larger", NA)

large_rect_sites_df = make_microb_df(large_rect_sites, "rect", "large", "sites")

large_rect_sp_df = make_microb_df(large_rect_sp, "rect", "large", "sites")
```

```{r comparitivePlot}
total_runs = rbind(smallest_square_df,
                   small_square_df,
                   small_rect_sites_df,
                   small_rect_sp_df,
                   large_square_df)

p_comp = ggplot(total_runs, aes(x = expr, y = time)) +
  geom_boxplot() +
  facet_grid(shape ~ size) +
  scale_y_log10()
```

