---
title: "How to use funrar, an example with plant communities dataset."
author: "Denelle Pierre & Greni\u00e9 Matthias"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The idea of Functional Rarity is to measure two components of the rarity of a species (or an individual). Indeed, in community ecology, people are generally interested in the rarity of a species in terms of abundances. A species with a low abundance will be considered as rare. From a functional ecology perspective, this does not take into consideration the "role" that a given species plays in the ecosystem, its particular niche. A framework is being developed of various indices to characterize how this function could be rare locally or regionally

In their article, Violle et al. introduced 4 indices to compute functional rarity indices. funrar package enables any user to compute them on any dataset.

# Dataset example

To show how the package works, We are using a dataset describing the distribution of 82 species of Alpine plants in 75 sites. This dataset was collected by Choler et al. and is presented in the following article.

Choler, P. (2005) Consistent shifts in Alpine plant traits along a mesotopographical gradient. Arctic,
Antarctic, and Alpine Research, 37,444-453.

Species traits and environmental variables are also available.

# Functional rarity indices from the site-species matrix

```{r}

data("aravo", package = "ade4")


# Site-species matrix stored in aravo$spe
mat <- as.matrix(aravo$spe)

```

## Distance matrix computation

The indices rely on the computation of a distance matrix. It represents the functional distance between two species given a particular set of traits. From a species traits matrix you can easily compute a distance matrix using function `compute_dist_matrix()`.

In order to compute distance matrix, species names must be specified as **rownames** in the traits table. And they will be named similarly in the distance matrix. Species names must be characters and not factors.

The function relies on the `daisy()` function from package `cluster` and the default metric is Gower's distance to take into account ordinal, categorical and binary traits.

```{r}
tra <- aravo$traits[, c("Height", "SLA", "N_mass")]

library(outlieR)

dist_mat <- compute_dist_matrix(tra)
dist_mat[1:5, 1:5]

```

## Distinctiveness computation

### Formula

The distinctiveness measures how a species is locally functionally rare. From given functional distances, it is computed as such:

$$
D_i = \frac{\sum_{\substack{j = 1, \\
                            i \neq j
                            }}^{N} d_{ij}}{N-1},
$$

with $D_i$ distinctiveness of species $i$, $d_{ij}$ the functional distance between species $i$ and species $j$, $N$ the number of species present in considered community.

When weighted by abundances the formula becomes:

$$
D_i = \frac{\sum_{\substack{j = 1, \\
                            i \neq j
                            }}^{N} d_{ij}\times A_j}{\sum_{\substack{j = 1, \\
                            i \neq j
                            }}^{N} A_j},
$$
with the same terms as above, and $A_j$ the relative abundance of species $j$ in percent, in the community.


### Computation

Using `outlieR` distinctiveness values can be computed using function `distinctiveness()`:

```{r distinctivenessComputation}

# Compute distinctiveness for each species on each site
di = pres_distinctiveness(pres_matrix = mat,  # The site x species table
                       dist_matrix = dist_mat)  # Functional Distance matrix

head(di)
```

The syntax for `pres_distinctiveness()` is first the table and then the distance matrix. The function returns a site-species matrix filled with `Di` values, i.e. the species distinctiveness in each species per site combination.

For abundance weighted distinctiveness you need to have a column containing relative abundances in your data frame as such:

```{r abundDist}

# Compute distinctiveness for each species on each site
di = pres_distinctiveness(pres_matrix = mat,  # The site x species table
                     dist_matrix = dist_mat)  # Functional Distance matrix

di[1:5, 1:5]

```


## Scarcity computation

### Formula

$$
S_i = \exp(-NA_i\log2),
$$

with $S_i$ the scarcity of species $i$, $N$ the number of species in the local community, $A_i$ the relative abundance (in percent) of species $i$ in the community.


### Computation

With `outlieR` it can be computed with `scarcity()` function with a syntax analog to `distinctiveness()`

```{r scarcityComp}

si = pres_scarcity(pres_matrix = mat)

si[1:5, 1:5]

```

## Uniqueness computation

## Uniqueness

### Formula

$$
U_i = \text{min}(d_{ij}), \forall j \in [1, N_R], j \neq i,
$$

with $U_i$ the uniqueness of species $i$, $d_{ij}$ the functional distance between species $i$ and species $j$, $N_R$ the number of species in the regional pool.

### Computation

`uniqueness()` follows a similar syntax, but beware that given community table and distance matrix should be given out of **regional species pool**. And the syntax is also similar:

```{r uniqComp}

ui = pres_uniqueness(mat, dist_mat)

ui[1:5, 1:5]

```
## Restrictedness computation

The restrictedness measures how a species is regionally rare. The following function thus represents species' occupancy of the set of communities.

$$
R_i = 1 - N_i/N_tot
$$

with $R_i$ the restrictedness of species $i$, $N_i$ the number of sites where species $i$ is found and $N_tot$ the total number of sites.


```{r}
ri = pres_restrictedness(mat)

head(ri)

```

# Functional rarity indices from a tidy data.frame

In some cases, datasets are not formatting following the usual site-species matrix scheme and the information is presented in a data.frame.
funrar package contains functions to compute the same four functional rarity indices as before but with a data.frame as an input.

We also included functions to go from one format to the other.

## Formatting the matrix into a data.frame

```{r}

dat <- matrix_to_tidy(mat, "value", "site", "species")

# The reverse function is provided and gives the same original matrix
identical(as.numeric(tidy_to_matrix(dat, "site", "species", "value")), as.numeric(mat))

```


## Distinctiveness computation

### Computation

Using `outlieR` distinctiveness values can be computed using function `distinctiveness()`:

```{r computeDi}

# Species should be character
dat$species = as.character(dat$species)

# Compute distinctiveness for each species on each site
di_df = distinctiveness(com_table = dat,  # The site x species table
                            sp_col = "species",  # Name of the species column
                            com = "site",  # Name of the community column
                            abund = NULL,  # Relative abundances column (facultative)
                            dist_matrix = dist_mat)  # Functional Distance matrix

head(di_df)

```

The syntax for `distinctiveness()` is first the table, then the name of the species column, then the name of the community column, then eventually the name of the relative abundance column and finally the distance matrix. The function add a `Di` column giving the species distinctiveness in each species per site combination.

For abundance weighted distinctiveness you need to have a column containing relative abundances in your data frame as such:

```{r abundDi}

di_df = distinctiveness(dat, "species", "site", "value", dist_mat)

head(di_df)

```

## Scarcity computation

### Computation

With `outlieR` it can be computed with `scarcity()` function with a syntax analog to `distinctiveness()`

```{r siComp}

si_df = scarcity(dat, "species", "site", "value")

head(si_df)

```
## Uniqueness computation

### Computation

`uniqueness()` follows a similar syntax, but beware that given community table and distance matrix should be given out of **regional species pool**. And the syntax is also similar:

```{r uiComp}

ui_df = uniqueness(dat, "species", dist_mat)

head(ui_df)
dim(ui_df[!duplicated(ui_df$species), ])

```

## Restrictedness computation

### Computation

```{r}

# Species should be character
dat$site = as.character(dat$site)

ri_df = restrictedness(dat, "site", "species")

head(ri_df)

```

```




